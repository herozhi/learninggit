# Pipeline only create by Merge Request
# check Version Code update if target branch is master

stages:
  - setup         # 基础构建
  - check_version # version 更新检查
  - test          # 单元测试
  - benchmark     # 性能压测
  - cleanup       # 清理

# check & init env
before_script:
  - date && pwd && whoami && id
  - export PATH="$GOROOT/bin:$GOPATH/bin:$PATH"
  - cd $CI_PROJECT_DIR && export CI_COMMIT_MSG=$(git log -1 --format='%cn | %s')  # commit message
  - env && which go

# build project
setup:
  stage: setup
  only:
    variables:
      - $CI_MERGE_REQUEST
  script:
    - if [ -d $GOPATH ]; then rm -rf $GOPATH; fi
    - mkdir -p $GOPATH
    - mkdir -p $KITEROOT
    - cp -r $DEP_REPO_DIR $GOPATH # 减少三方包拉取时间
    - cp -r $CI_PROJECT_DIR $KITEROOT
    - cd $KITEROOT/$CI_PROJECT_NAME
    - git config --global url."git@code.byted.org:".insteadOf "https://code.byted.org/"
    - go get -v -d ./...

# MR 目标分支 master, 进行 version code 检查
check_version:
  stage: check_version
  only:
    variables:
      - $CI_MERGE_REQUEST
    variables:
      - $MR_TARGET_REF == "master"
  script:
    # get version code from version.go
    - SOURCE_VERSION=`grep 'Version\s*=\s*\"v[0-9]\{1,\}\.[0-9]\{1,\}\.[0-9]\{1,\}\"' *.go | awk -F '\"' '{print $(NF-1)}'`
    - git checkout master
    - MASTER_VERSION=`grep 'Version\s*=\s*\"v[0-9]\{1,\}\.[0-9]\{1,\}\.[0-9]\{1,\}\"' *.go | awk -F '\"' '{print $(NF-1)}'`
    - git checkout $CI_COMMIT_SHA
    # version 检查, 相同则退出
    - IFS="." sarr=($SOURCE_VERSION) marr=($MASTER_VERSION) snum=${sarr[0]}*10000+${sarr[1]}*100+${sarr[2]} mnum=${marr[0]}*10000+${marr[1]}*100+${marr[2]}
    - if [[ $snum -le $mnum ]]; then echo "Version 未更新, $CI_COMMIT_REF_NAME[$SOURCE_VERSION] <= $MR_TARGET_REF[$MASTER_VERSION]" && exit -1; fi

test:
  stage: test
  only:
    variables:
      - $CI_MERGE_REQUEST
  script:
    - cd $KITEROOT/$CI_PROJECT_NAME
    - go get -v github.com/facebookgo/ensure
    - go test -v -cover -bench -race ./...

# MR 目标分支 master 或 develop, 需要执行 benchmark
# hotfix/ 分支跳过本阶段
benchmark:
  stage: benchmark
  only:
    variables:
      - $CI_MERGE_REQUEST
    variables:
      - $MR_TARGET_REF == "develop"
      - $MR_TARGET_REF == "master"
  except:
    variables:
      - $MR_SOURCE_REF =~ /hotfix/
  script:
    - which benchcmp
    - rm -rf $RECORD_REPO && git clone git@code.byted.org:kite/testrecord.git $RECORD_REPO  # get record repo
    - cd $KITEROOT/$CI_PROJECT_NAME
    - BenchmarkCMD="go test -bench=. -benchmem -run=none ./..." # benchmark command
    # 获取 源分支 benchmark 数据 commit.txt
    - SourceTxt="${RECORD_REPO}/benchmark/${CI_PROJECT_NAME}/${CI_COMMIT_SHA}.txt"
    - if [ -f ${SourceTxt} ]; then rm ${SourceTxt}; fi
    - ${BenchmarkCMD} > ${SourceTxt}
    # 获取 目标分支 benchmark 数据 commit.txt
    - git checkout $MR_TARGET_REF
    - TargetCommit=$(git log -1 --pretty=%H)
    - TargetTxt="${RECORD_REPO}/benchmark/${CI_PROJECT_NAME}/${TargetCommit}.txt"
    - if ! [ -f ${TargetTxt} ]; then echo "benchmark $MR_TARGET_REF..." && ${BenchmarkCMD} > ${TargetTxt}; fi
    - git checkout $CI_COMMIT_SHA
    # benchmark 性能对比
    - CmpLog="${RECORD_REPO}/benchcmp/${CI_PROJECT_NAME}/${CI_COMMIT_SHA}.log"
    - CmpLogURL="${RECORD_HTTP_PREFIX}/benchcmp/${CI_PROJECT_NAME}/${CI_COMMIT_SHA}.log"
    - if [ -f ${CmpLog} ]; then rm ${CmpLog}; fi
    - benchcmp ${TargetTxt} ${SourceTxt} > ${CmpLog}
    # 组织 lark 文本内容, 显式转义
    - CONTENT="branch=${CI_COMMIT_REF_NAME}\ntarget=${MR_TARGET_REF}\ncommit=${CI_COMMIT_SHA}\n${CI_COMMIT_MSG}\nBenchmark:${CmpLogURL}\n"
    - "curl ${LARK_WEBHOOK} -X POST -H \"Content-Type: application/json\" -d \"{\\\"title\\\": \\\"${CI_PROJECT_NAME} benchmark\\\", \\\"text\\\": \\\"${CONTENT}\\\"}\""
    # 记录更新 push
    - cd ${RECORD_REPO} && git add . && git commit -m "add ${CI_PROJECT_NAME} benchmark record, commit ${CI_COMMIT_SHA}, ${CI_COMMIT_MSG}" && git push && cd -

cleanup:
  stage: cleanup
  only:
    variables:
      - $CI_MERGE_REQUEST
  script:
    - go clean -modcache
    - echo "GOPATH=${GOPATH}"
    - chmod -R +w $GOPATH
    - rm -rf $GOPATH
  when: always
