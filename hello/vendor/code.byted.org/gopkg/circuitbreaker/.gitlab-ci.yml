image: golang:latest

variables:
  GOPROXY: "https://go-mod-proxy.byted.org,https://goproxy.cn,https://goproxy.io,https://proxy.golang.org,direct"
  GOPRIVATE: "*.byted.org,*.everphoto.cn"
  GOSUMDB: "sum.golang.google.cn"

before_script:
  - date && pwd && whoami && id
  - export CI_COMMIT_MSG=$(git log -1 --format='%cn | %s')  # commit message
  - which go
  - eval "$(ssh-agent -s)"
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - ssh-keyscan code.byted.org >> ~/.ssh/known_hosts
  - git config --global url."git@code.byted.org:".insteadOf "https://code.byted.org/"
  - go get
  - export GOMAXPROCS=4

stages:
  - lint
  - test
  - benchmark

lint:
  stage: lint
  tags:
    - shared
  script:
    - test -z "$(gofmt -s -l .)"
    - go vet ./...

test:
  stage: test
  tags:
    - shared
  script:
    - go test -race ./...

benchmark:
  stage: benchmark
  tags:
    - shared
  script:
    - go test -bench=. -benchmem -run=none ./... > bench_result.txt
    - cat bench_result.txt
  artifacts:
    paths:
      - bench_result.txt
